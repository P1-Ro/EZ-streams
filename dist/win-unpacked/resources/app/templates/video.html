<!DOCTYPE html>
<html>
<head>
    <title>afterglow player</title>
    <script src="//cdn.jsdelivr.net/npm/afterglowplayer"></script>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
</head>
<body style="overflow: hidden">
<video class="afterglow" id="myvideo" width="1280" height="720" preload="auto" autoplay crossorigin
       allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">
    <source type="video/mp4" src="{{ url }}"/>
    {% if subtitles %}
        <track label="Default" kind="subtitles" srclang="en" id="subtitles" src="{{ subtitles }}" default>
    {% endif %}
</video>
<a class="hide" id="downloader" download></a>
</body>
<script>
    (function () {
        let loader = window.parent.document.getElementById("loader");
        loader ? loader.classList.add("hide") : false;


        let init = true;

        function download(url) {
            let a = document.getElementById("downloader");
            a.href = url;
            a.click();
        }

        function makeCall(url, onComplete) {
            let oReq = new XMLHttpRequest();
            if (onComplete) {
                oReq.addEventListener("load", onComplete);
            }
            oReq.open("GET", url);
            oReq.send();
        }

        function createKodiButton() {
            let img = "<img src=\"{{ url_for("static", filename="airplay.png") }}\" height=\"16\" width =\"16\">";
            let div = document.createElement("div");
            div.classList.add("vjs-button", "vjs-control", "play-on-kodi");
            div.innerHTML = img;
            div.onclick = function () {
                let urlOfVideo = afterglow.players[0].videoelement["node"].currentSrc;
                urlOfVideo = window.btoa(urlOfVideo);
                let href = "/to_kodi/{0}";
                href = href.replace("{0}", urlOfVideo);
                afterglow.getPlayer('myvideo').pause();


                makeCall(href, function () {
                    let response = JSON.parse(this.responseText);
                    if (!response.error) {
                        window.parent.makeNotification("Video is now playing");
                    } else {
                        window.parent.makeNotification("Error", response.error.code);
                    }
                });
            };
            return div;
        }

        function createDowloadButton() {
            let img = "<img src=\"{{ url_for("static", filename="download.png") }}\" height=\"16\" width =\"16\">";
            let div = document.createElement("div");
            div.classList.add("vjs-button", "vjs-control", "play-on-kodi");
            div.innerHTML = img;
            div.onclick = function () {

                setTimeout(function () {
                    let urlOfVideo = afterglow.players[0].videoelement["node"].currentSrc;
                    urlOfVideo = urlOfVideo.slice(0, urlOfVideo.indexOf("?"));
                    download(urlOfVideo);
                }, 200);

                let subtitlesUrl = document.getElementById("subtitles").src;
                download(subtitlesUrl);

            };
            return div;
        }

        afterglow.on('myvideo', 'play', function () {
            if (init) {
                let volume = document.getElementsByClassName("vjs-volume-menu-button")[0];
                let div = createKodiButton();
                volume.parentElement.insertBefore(div, volume);

                let div2 = createDowloadButton();
                volume.parentElement.insertBefore(div2, volume);

                init = false;
            }
        });
    }).call(window)
</script>
</html>